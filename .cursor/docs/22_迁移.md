---
tags: []
title: Requirement - Beancount-Trans è¿ç§»
type: Requirement
created_time: 2025-11-28 15:41:01
modify_time: 2025-12-09 10:00:00
aliases:
  - "è´¦æœ¬è¿ç§»åŠŸèƒ½"
  - "Giteaé›†æˆ"
req_id: REQ-022
req_status: Draft
req_priority: High
req_effort: Low
req_value: High
startDate: 2025-11-28 15:41:01
endDate:
related_release:
---
# è´¦æœ¬è¿ç§»åŠŸèƒ½ï¼ˆå¹³å°æ‰˜ç®¡ Gitea ä»“åº“ï¼‰

## 1. éœ€æ±‚æ¦‚è¿°

### 1.1 èƒŒæ™¯æè¿°

ç”¨æˆ·å·²ç»æœ‰ä¸€å¥—è‡ªå®šä¹‰æ ¼å¼çš„è´¦æœ¬åœ¨ä½¿ç”¨ï¼ŒåŒ…å«å¤šå¹´çš„è´¦åŠ¡æ•°æ®ã€è‡ªå®šä¹‰è´¦æˆ·ä½“ç³»ã€ä¸ªæ€§åŒ–é…ç½®ç­‰ã€‚ç°æœ‰å¹³å°ä»…æ”¯æŒé€šè¿‡ç½‘é¡µä¸Šä¼ è´¦å•å¹¶è‡ªåŠ¨è§£æï¼Œæ— æ³•ç›´æ¥å¯¼å…¥ç”¨æˆ·å·²æœ‰çš„å®Œæ•´è´¦æœ¬ç»“æ„ã€‚

**ç°æœ‰é—®é¢˜ï¼š**
- ç”¨æˆ·æ— æ³•å°†æœ¬åœ°è´¦æœ¬åŒæ­¥åˆ°å¹³å°
- è´¦æœ¬ä¿®æ”¹åªèƒ½é€šè¿‡ç½‘é¡µæ“ä½œï¼Œæ•ˆç‡ä½ä¸‹
- ç¼ºä¹ç‰ˆæœ¬æ§åˆ¶ï¼Œæ— æ³•è¿½è¸ªè´¦æœ¬å˜æ›´å†å²

### 1.2 ç›®æ ‡ç”¨æˆ·

- **æ ¸å¿ƒç”¨æˆ·**ï¼šå·²ä½¿ç”¨ Beancount è¿›è¡Œè®°è´¦ä¸”æ‹¥æœ‰å®Œæ•´è´¦æœ¬çš„ç”¨æˆ·
- **æŠ€æœ¯ç‰¹å¾**ï¼šç†Ÿæ‚‰ Git ç‰ˆæœ¬æ§åˆ¶å·¥å…·ï¼Œå…·å¤‡å‘½ä»¤è¡Œæ“ä½œèƒ½åŠ›
- **ä½¿ç”¨åœºæ™¯**ï¼šå¸Œæœ›åœ¨æœ¬åœ°ç¼–è¾‘å™¨ä¸­ç¼–è¾‘è´¦æœ¬ï¼ŒåŒæ—¶äº«å—å¹³å°çš„è§£æã€å¯è§†åŒ–ã€éšæ—¶éšåœ°è®¿é—®ç­‰åŠŸèƒ½

### 1.3 é¢„æœŸä»·å€¼

- **é™ä½è¿ç§»é—¨æ§›**ï¼šç”¨æˆ·å¯ä»¥ä¸€é”®å°†ç°æœ‰è´¦æœ¬è¿ç§»åˆ°å¹³å°ï¼Œä¿ç•™åŸæœ‰ç›®å½•ç»“æ„å’Œé…ç½®
- **æå‡ç¼–è¾‘æ•ˆç‡**ï¼šç”¨æˆ·å¯ä»¥ä½¿ç”¨ç†Ÿæ‚‰çš„æœ¬åœ°ç¼–è¾‘å™¨ï¼ˆVS Code + Beancount æ’ä»¶ï¼‰ç¼–è¾‘è´¦æœ¬
- **ç‰ˆæœ¬æ§åˆ¶**ï¼šé€šè¿‡ Git å®ç°è´¦æœ¬ç‰ˆæœ¬ç®¡ç†ï¼Œæ”¯æŒå†å²å›æº¯å’Œå˜æ›´è¿½è¸ª
- **ç¦»çº¿æ”¯æŒ**ï¼šç”¨æˆ·å¯ä»¥ç¦»çº¿ç¼–è¾‘è´¦æœ¬ï¼Œè”ç½‘ååŒæ­¥åˆ°å¹³å°
- **å¸å¼•å­˜é‡ç”¨æˆ·**ï¼šBeancount ç¤¾åŒºå­˜é‡ç”¨æˆ·æ˜¯é«˜ä»·å€¼ç”¨æˆ·ï¼Œæä¾›è¿ç§»èƒ½åŠ›å¯æœ‰æ•ˆå¸å¼•è¿™éƒ¨åˆ†ç”¨æˆ·

---

## 2. åŠŸèƒ½éœ€æ±‚

**æ ¸å¿ƒç›®æ ‡ï¼šå°†å·²æœ‰è´¦æœ¬è¿ç§»è‡³å¹³å°ï¼Œé€šè¿‡å¹³å°æ‰˜ç®¡çš„æ ‡å‡†Gitä»“åº“å®ç°ç‰ˆæœ¬æ§åˆ¶**

### 2.1 åŠŸèƒ½æè¿°

#### 2.1.1 æ•´ä½“æ¶æ„

å¹³å°ä½¿ç”¨**å•ä¸€ Gitea æœºå™¨äººç”¨æˆ·**æ¥ä¸ºå¹³å°ç”¨æˆ·åˆ›å»ºç‹¬ç«‹çš„ä»“åº“ï¼ˆå³ï¼šä¸€ä¸ª Gitea è´¦å·ä¸‹ç»´æŠ¤æ‰€æœ‰ç”¨æˆ·çš„ä¸“å±ä»“åº“ï¼‰ï¼Œå®ç°**å¹³å°æ‰˜ç®¡æ¨¡å¼**ï¼š

- **æ ‡å‡†ä»“åº“ç»“æ„**ï¼šæ–°ä»“åº“åŸºäº `Beancount-Trans-Assets` æ¨¡æ¿åˆå§‹åŒ–ã€‚
- **ç”¨æˆ·å¯ç®¡ç†çš„ç›®å½•**ï¼šå¦‚ `account/`ã€æ—¥å¸¸è´¦æœ¬ç›®å½•ï¼Œç”¨æˆ·é€šè¿‡æœ¬åœ°ç¼–è¾‘å’Œ push è¿›è¡Œç®¡ç†ã€‚
- **å¹³å°ä¸“å±ç®¡ç†çš„ç›®å½•**ï¼šå¦‚ `trans/*`ï¼Œå¹³å°åœ¨æ­¤è¾“å‡ºè§£æç»“æœï¼Œç”¨æˆ·æ— é¡»ç®¡ç†ã€‚

**æ ¸å¿ƒåŸåˆ™**ï¼š
- **å¹³å°æ‰˜ç®¡**ï¼šç”¨æˆ·å¯ç”¨ Git åŠŸèƒ½æ—¶é€‰æ‹©åˆ›å»ºæ–¹å¼ï¼Œé€‰æ‹©åˆ›å»ºç©ºä»“åº“æˆ–åˆ›å»ºåŸºäº Beancount-Trans-Assets æ¨¡æ¿åˆå§‹åŒ–çš„ä»“åº“ã€‚
- **Deploy Key è®¤è¯**ï¼šå¹³å°ç”Ÿæˆä¸“ç”¨å¯†é’¥ï¼Œç”¨æˆ·æ— éœ€ç®¡ç† Token
- **æƒé™æ§åˆ¶**ï¼šä»“åº“å¤§å°é™åˆ¶ï¼Œç¦ç”¨éå¿…è¦åŠŸèƒ½ï¼Œé˜²æ­¢æ»¥ç”¨
- **æ°¸è¿œä¸ä¼šå†²çª**ï¼š`trans/` ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶ä¸åœ¨ Git ä¸­ï¼Œå¹³å° pull ä¸ä¼šè¦†ç›–è§£æç»“æœ

**æ¶æ„å›¾ï¼š**

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”¨æˆ·æœ¬åœ°       â”‚      â”‚  å¹³å° Gitea     â”‚      â”‚   å¹³å°åç«¯       â”‚
â”‚   Git å®¢æˆ·ç«¯    â”‚ â”€â”€â”€â†’ â”‚  æ ‡å‡†ä»“åº“       â”‚ â”€â”€â”€â†’ â”‚ (åŒæ­¥+è§£æ+Fava) â”‚
â”‚   VS Code ç­‰    â”‚ push â”‚               â”‚ pull â”‚  Assets ç›®å½•    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†‘                        â”‚                        â”‚
        â”‚                        â”‚                        â†“
        â”‚               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â””â”€â”€ Deploy Key â”€â”‚  æƒé™æ§åˆ¶        â”‚    â”‚  trans/*.bean   â”‚
                       â”‚  - å¤§å°é™åˆ¶      â”‚    â”‚  (å¹³å°å†™å…¥)     â”‚
                       â”‚  - åŠŸèƒ½é™åˆ¶      â”‚    â”‚                 â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2.1.2 å¹³å°æ‰˜ç®¡ä»“åº“

| ç‰¹æ€§ | è¯´æ˜ |
|------|------|
| **ä»“åº“åœ°å€** | `https://gitea.dhr2333.cn/beancount-trans/{user_id}-beancount.git` |
| **åˆ›å»ºæ–¹å¼** | ç”¨æˆ·å¯ç”¨ Git åŠŸèƒ½æ—¶é€‰æ‹©åˆ›å»ºæ–¹å¼ï¼Œé€‰æ‹©åˆ›å»ºç©ºä»“åº“æˆ–åˆ›å»ºåŸºäº Beancount-Trans-Assets æ¨¡æ¿åˆå§‹åŒ–çš„æ ‡å‡†ç»“æ„ä»“åº“ã€‚ |
| **æ ‡å‡†ç»“æ„** | åŸºäº `Beancount-Trans-Assets` æ¨¡æ¿åˆå§‹åŒ– |
| **æƒé™æ§åˆ¶** | Deploy Key è®¤è¯ï¼Œå¤§å°é™åˆ¶ 20MB |

#### 2.1.3 ç›®å½•åˆ†åŒºè®¾è®¡

åŸºäº `Beancount-Trans-Assets` é¡¹ç›®çš„ç°æœ‰è®¾è®¡ï¼š

```text
ç”¨æˆ·è´¦æœ¬ä»“åº“/                      â† Git ä»“åº“
â”œâ”€â”€ main.bean                     â† å…¥å£æ–‡ä»¶ï¼Œinclude æ‰€æœ‰å†…å®¹, æ¨¡æ¿åŒ…å« include "trans/main.bean" è‡ªåŠ¨å¼•å…¥å¹³å°è§£æç»“æœã€‚è‹¥ç”¨æˆ·æ¨é€çš„ä»“åº“æœªåŒ…å« include "trans/main.bean" å†…å®¹ï¼Œä¹Ÿä¸å½±å“å¹³å°æ­£å¸¸è¿è¡Œï¼Œåªä¸è¿‡ä¸ä¼šæ˜¾ç¤ºå¹³å°è§£æç»“æœ
â”œâ”€â”€ account/                      â† è´¦æˆ·å®šä¹‰
â”‚   â”œâ”€â”€ assets.bean
â”‚   â”œâ”€â”€ expenses.bean
â”‚   â””â”€â”€ ...
â”œâ”€â”€ 2022_template/                â† äº¤æ˜“è®°å½•æŒ‰æœˆåˆ†åŒº
â”‚   â”œâ”€â”€ 01-expenses.bean
â”‚   â””â”€â”€ ...
â”œâ”€â”€ depreciation.bean             â† æŠ˜æ—§è®°å½•
â”‚â”€â”€ trans/                        â† å¹³å°è§£æç»“æœç›®å½•
â”‚   â”œâ”€â”€ main.bean                 â† å¹³å°è§£æç»“æœå…¥å£æ–‡ä»¶
â”‚   â””â”€â”€ {file_name}.bean         â† å¹³å°è§£æç»“æœæ–‡ä»¶
```

#### 2.1.4 å¹³å°ä¸ä»“åº“åŒæ­¥

- **åŒæ­¥æ–¹å‘**ï¼š**å•å‘æ‹‰å–**ï¼ˆå¹³å°åª pullï¼Œä¸ pushï¼‰
  - **æ‹‰å–**ï¼šç”¨æˆ· push åˆ°å¹³å°ä»“åº“åï¼Œå¹³å°åŒæ­¥æ›´æ–°ï¼ˆæ‰‹åŠ¨è§¦å‘æˆ–Webhookï¼‰
  - **å†™å…¥**ï¼šå¹³å°è§£æè´¦å•åï¼Œå†™å…¥ `trans/` ç›®å½•
- **è§¦å‘æ–¹å¼**ï¼š
  - **æ‰‹åŠ¨è§¦å‘**ï¼šç”¨æˆ·åœ¨å¹³å°ç‚¹å‡»"ç«‹å³åŒæ­¥"æŒ‰é’®
  - **Webhook**ï¼šGitea push åè‡ªåŠ¨é€šçŸ¥å¹³å°åŒæ­¥
- **æƒé™ç®¡ç†**ï¼š
  - **Deploy Key**ï¼šå¹³å°ç”Ÿæˆä¸“ç”¨å¯†é’¥ç»™ç”¨æˆ·ï¼Œç”¨äº git æ“ä½œ
  - **ä»“åº“æ§åˆ¶**ï¼šå¹³å°ç®¡ç†å‘˜æƒé™ï¼Œå¯è®¾ç½®å¤§å°é™åˆ¶å’ŒåŠŸèƒ½æƒé™

#### 2.1.5 ä»“åº“åˆå§‹åŒ–

**åˆå§‹åŒ–æµç¨‹**ï¼š

ç”¨æˆ·å¯ç”¨ Git åŠŸèƒ½æ—¶å¹³å°è‡ªåŠ¨æ‰§è¡Œï¼š
1. è°ƒç”¨ Gitea API åˆ›å»ºç©ºä»“åº“æˆ–æ ‡å‡†ä»“åº“
2. è‹¥é€‰æ‹©åˆ›å»ºæ ‡å‡†ä»“åº“ï¼Œåˆ™åŸºäº `Beancount-Trans-Assets` æ¨¡æ¿åˆå§‹åŒ–ç›®å½•ç»“æ„
3. ç”Ÿæˆç”¨æˆ·ä¸“ç”¨ Deploy Key
4. è®¾ç½®ä»“åº“æƒé™å’Œå¤§å°é™åˆ¶
5. è¿”å›ä»“åº“è®¿é—®ä¿¡æ¯ç»™ç”¨æˆ·

### 2.2 ç”¨æˆ·æ•…äº‹

**ç”¨æˆ·æ•…äº‹ 1ï¼šè¿ç§»æœ¬åœ°è´¦æœ¬åˆ°å¹³å°**

```text
ä½œä¸ºå·²æœ‰ Beancount è´¦æœ¬çš„ç”¨æˆ·ï¼Œ
æˆ‘å¸Œæœ›å°†æœ¬åœ°è´¦æœ¬æ¨é€åˆ°å¹³å°ï¼Œ
ä»¥ä¾¿åœ¨å¹³å°ä¸Šä½¿ç”¨ Fava æŸ¥çœ‹æŠ¥è¡¨å’Œä½¿ç”¨å¹³å°çš„è§£æåŠŸèƒ½ã€‚
```

**ç”¨æˆ·æ•…äº‹ 2ï¼šå…‹éš†å¹³å°è´¦æœ¬åˆ°æœ¬åœ°**

```text
ä½œä¸ºå¹³å°ç”¨æˆ·ï¼Œ
æˆ‘å¸Œæœ›å°†å¹³å°è´¦æœ¬å…‹éš†åˆ°æœ¬åœ°ï¼Œ
ä»¥ä¾¿ä½¿ç”¨ VS Code ç­‰ç¼–è¾‘å™¨è¿›è¡Œç¼–è¾‘ï¼Œå¹¶äº«å—æœ¬åœ° Beancount æ’ä»¶çš„è¯­æ³•é«˜äº®å’Œæ ¡éªŒåŠŸèƒ½ã€‚
```

**ç”¨æˆ·æ•…äº‹ 3ï¼šåŒæ­¥æœ¬åœ°ä¿®æ”¹åˆ°å¹³å°**

```text
ä½œä¸ºåœ¨æœ¬åœ°ç¼–è¾‘è´¦æœ¬çš„ç”¨æˆ·ï¼Œ
æˆ‘å¸Œæœ›é€šè¿‡ git push å°†ä¿®æ”¹åŒæ­¥åˆ°å¹³å°ï¼Œ
ä»¥ä¾¿åœ¨å¹³å°ä¸ŠæŸ¥çœ‹æœ€æ–°çš„è´¦æœ¬æ•°æ®å’ŒæŠ¥è¡¨ã€‚
```

**ç”¨æˆ·æ•…äº‹ 4ï¼šè·å–å¹³å°ç”Ÿæˆçš„æ–°è´¦å•**

```text
ä½œä¸ºæœ¬åœ°ç¼–è¾‘è´¦æœ¬çš„ç”¨æˆ·ï¼Œ
æˆ‘å¸Œæœ›èƒ½å¤Ÿè·å–åˆ°å¹³å°åœ¨ trans/ ç›®å½•ä¸‹è§£æç”Ÿæˆçš„æ–°è´¦å•ï¼Œ
ä½†ç”±äº trans/ ç›®å½•ä¸è¢« Git ç®¡ç†ï¼Œgit pull æ— æ³•åŒæ­¥è¿™äº›å†…å®¹ã€‚
å› æ­¤ï¼Œæˆ‘éœ€è¦å¹³å°æä¾›å…¶ä»–æ–¹å¼ï¼ˆå¦‚å¯¼å‡ºæˆ–ä¸‹è½½æ¥å£ï¼‰ä»¥ä¾¿è·å–å’Œä¿æŒæœ¬åœ°ä¸å¹³å°è´¦å•æ•°æ®çš„ä¸€è‡´ã€‚
```

### 2.3 åŠŸèƒ½è¾¹ç•Œ

#### åŒ…å«èŒƒå›´

- [x] å¹³å°æ‰˜ç®¡ Gitea ä»“åº“è‡ªåŠ¨åˆ›å»º
- [x] æ ‡å‡†ç›®å½•ç»“æ„è‡ªåŠ¨åˆå§‹åŒ–ï¼ˆåŸºäº `Beancount-Trans-Assets` æ¨¡æ¿ï¼‰
- [x] Deploy Key è‡ªåŠ¨ç”Ÿæˆå’Œé…ç½®
- [x] å¹³å°å•å‘æ‹‰å–ä»“åº“ï¼ˆæ‰‹åŠ¨è§¦å‘ + Webhookï¼‰
- [x] ç›®å½•åˆ†åŒºè®¾è®¡ï¼ˆå¹³å°ä»…ç®¡ç†`trans/`ç›®å½•ï¼‰
- [x] å‰ç«¯ä»“åº“ç®¡ç†ç•Œé¢
- [x] ä»“åº“æƒé™å’Œå¤§å°æ§åˆ¶
- [x] ç”¨æˆ·æ–‡æ¡£ï¼ˆä½¿ç”¨æŒ‡å—ã€Git æ“ä½œè¯´æ˜ï¼‰

#### ä¸åŒ…å«èŒƒå›´ï¼ˆç”± Git å¹³å°æä¾›ï¼‰

- Git åè®®å®ç° â†’ **Gitea å¹³å°å·²æä¾›**
- SSH æ”¯æŒ â†’ **Gitea å¹³å°å·²æä¾›**

#### ä¸å®ç°ï¼ˆè®¾è®¡å†³ç­–ï¼‰

- **å¤–éƒ¨ Git å¹³å°æ”¯æŒ**ï¼šåªä½¿ç”¨å¹³å°è‡ªå»º Giteaï¼Œä¸æ”¯æŒ GitHub/GitLab ç­‰
- **å¹³å°æ¨é€åˆ°ä»“åº“**ï¼šç”¨æˆ·å®Œå…¨æŒæ§ Gitï¼Œå¹³å°åªè¯»
- **ç”¨æˆ·ç›´æ¥è®¿é—® Gitea**ï¼šç”¨æˆ·åªèƒ½é€šè¿‡ git å‘½ä»¤æ“ä½œï¼Œæ— æ³•ç™»å½• Gitea Web ç•Œé¢
- å¤šä»“åº“æ”¯æŒï¼ˆä¸€ä¸ªç”¨æˆ·åªæœ‰ä¸€ä¸ªæ ‡å‡†è´¦æœ¬ä»“åº“ï¼‰

---

## 3. æ¶‰åŠæ¨¡å—ä¸èŒè´£

### æ¶‰åŠæ¨¡å—

- [x] **Backend** - `Beancount-Trans-Backend/` - Django REST API #Topic/Ignore
- [x] **Frontend** - `Beancount-Trans-Frontend/` - Vue 3 + TypeScript #Topic/Ignore
- [ ] **Mobile** - `Beancount-Trans-Mobile/`ï¼ˆè§„åˆ’ä¸­ï¼‰ #Topic/Ignore
- [x] **Docs** - `Beancount-Trans-Docs/` - Docusaurus æ–‡æ¡£ #Topic/Ignore
- [x] **Assets** - `Beancount-Trans-Assets/` - Beancount è´¦æœ¬æ¨¡æ¿ #Topic/Ignore

### æœ¬éœ€æ±‚èŒè´£åˆ’åˆ†

| æ¨¡å—       | æœ¬éœ€æ±‚ä¸­çš„èŒè´£ | åŸå› è¯´æ˜ |
| -------- | -------- | ----------- |
| Backend  | Gitea API é›†æˆã€ä»“åº“è‡ªåŠ¨åˆ›å»ºã€Deploy Key ç®¡ç†ã€å•å‘æ‹‰å– | éœ€è¦è°ƒç”¨ Gitea APIã€æ‰§è¡Œ git pullã€ç®¡ç† Assets ç›®å½• |
| Frontend | ä»“åº“ç®¡ç†ç•Œé¢ã€åŒæ­¥çŠ¶æ€å±•ç¤ºã€Git æ“ä½œæŒ‡å¼• | ç”¨æˆ·æŸ¥çœ‹ä»“åº“ä¿¡æ¯ã€è§¦å‘åŒæ­¥ã€è·å– git å‘½ä»¤ |
| Docs     | ç¼–å†™ä½¿ç”¨æŒ‡å—ã€Git æ“ä½œæ•™ç¨‹ã€ç›®å½•ç»“æ„è¯´æ˜ | å¸®åŠ©ç”¨æˆ·ç†è§£å¹³å°æ‰˜ç®¡æ¨¡å¼å’Œ Git æ“ä½œ |
| Gitea æœåŠ¡ | Git åè®®ã€ä»“åº“å­˜å‚¨ã€Webhook | å¹³å°è‡ªå»ºæœåŠ¡ï¼Œç»Ÿä¸€ç®¡ç† |

### è·¨æ¨¡å—åä½œ

| åœºæ™¯ | æ¶‰åŠæ¨¡å— | åä½œæ–¹å¼ |
|------|----------|----------|
| åˆ›å»ºç”¨æˆ·ä»“åº“ | Backend + Gitea | ç”¨æˆ·æ³¨å†Œ â†’ åç«¯è°ƒç”¨ Gitea API åˆ›å»ºä»“åº“ â†’ åˆå§‹åŒ–æ ‡å‡†ç»“æ„ |
| åŒæ­¥è´¦æœ¬åˆ°å¹³å° | Gitea + Backend | ç”¨æˆ· push â†’ Gitea Webhook â†’ åç«¯ git pull â†’ æ›´æ–° Assets ç›®å½• |
| è§£æè´¦å• | Backend | åç«¯è§£æè´¦å• â†’ å†™å…¥ `trans/` ç›®å½• |
| ä»“åº“è®¿é—®ç®¡ç† | Frontend + Backend | å‰ç«¯æ˜¾ç¤ºä»“åº“ä¿¡æ¯ â†’ åç«¯æä¾› Deploy Key å’Œ git å‘½ä»¤ |
| Git æ“ä½œ | ç”¨æˆ·æœ¬åœ° + Gitea | ç”¨æˆ·ä½¿ç”¨ Deploy Key ä¸å¹³å° Gitea äº¤äº’ï¼Œå¹³å°ä¸å‚ä¸ push |

---

## 4. æŠ€æœ¯æ–¹æ¡ˆ

### 4.1 æ•´ä½“æ¶æ„

**å¹³å°æ‰˜ç®¡ Gitea ä»“åº“**ï¼Œä¸ºæ¯ä¸ªç”¨æˆ·åˆ›å»ºç‹¬ç«‹çš„ä»“åº“ï¼Œå¹³å°åªè´Ÿè´£æ‹‰å–å’Œè§£æï¼Œä¸æ¨é€åˆ°è¿œç¨‹ä»“åº“ã€‚

**æ ¸å¿ƒè®¾è®¡åŸåˆ™**ï¼š
- **å¹³å°æ‰˜ç®¡**ï¼šç”¨æˆ·å¯ç”¨ Git åŠŸèƒ½æ—¶é€‰æ‹©åˆ›å»ºæ–¹å¼ï¼ˆç©ºä»“åº“æˆ–åŸºäºæ¨¡æ¿ï¼‰
- **Deploy Key è®¤è¯**ï¼šå¹³å°ç”Ÿæˆä¸“ç”¨ SSH å¯†é’¥ï¼Œç”¨æˆ·æ— éœ€ç®¡ç† Token
- **æƒé™ä¸¥æ ¼æ§åˆ¶**ï¼šä»“åº“å¤§å°é™åˆ¶ 20MBï¼Œç¦ç”¨ Issues/Wiki/PR ç­‰éå¿…è¦åŠŸèƒ½
- **æ°¸ä¸å†²çª**ï¼š`trans/` ç›®å½•ä¸è¢« Git ç®¡ç†ï¼Œå¹³å° pull ä¸ä¼šè¦†ç›–è§£æç»“æœ
- **å•å‘åŒæ­¥**ï¼šå¹³å°åª pullï¼Œä¸ pushï¼Œç”¨æˆ·å®Œå…¨æŒæ§ Git ä»“åº“

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ç”¨æˆ·æ“ä½œå±‚                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æœ¬åœ° Git å®¢æˆ·ç«¯              å¹³å° Web UI                       â”‚
â”‚  (VS Code, CLI)             (ä»“åº“ç®¡ç†/è§£æ/Fava)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ push (Deploy Key)        â”‚ ç®¡ç†ç•Œé¢
         â–¼                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     å¹³å° Gitea æœåŠ¡                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  ç”¨æˆ·ä»“åº“é›†åˆï¼ˆbeancount-trans ç»„ç»‡ä¸‹ç»Ÿä¸€ç®¡ç†ï¼‰             â”‚ â”‚
â”‚  â”‚  - beancount-trans/{user_id}-beancount.git                â”‚ â”‚
â”‚  â”‚  - æƒé™æ§åˆ¶ï¼šDeploy Key + 20MB å¤§å°é™åˆ¶                    â”‚ â”‚
â”‚  â”‚  - ç¦ç”¨åŠŸèƒ½ï¼šIssues / Wiki / Pull Requests                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚ Webhook è§¦å‘ / æ‰‹åŠ¨è§¦å‘
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     å¹³å°åç«¯å±‚                                   â”‚
â”‚              Beancount-Trans-Backend                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ GitSync      â”‚  â”‚ Assets/      â”‚  â”‚ trans/       â”‚          â”‚
â”‚  â”‚ Service      â”‚â†’ â”‚ {username}/  â”‚  â”‚ (å¹³å°å†™å…¥)    â”‚          â”‚
â”‚  â”‚ (pull only)  â”‚  â”‚ (ç”¨æˆ·å†…å®¹)    â”‚  â”‚ ä¸åœ¨Gitä¸­    â”‚          â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚              â”‚          â”‚
â”‚  â”‚ Gitea API    â”‚  â”‚ ç”¨æˆ·è´¦æœ¬     â”‚  â”‚ è§£æç»“æœ     â”‚          â”‚
â”‚  â”‚ Client       â”‚  â”‚ + trans/     â”‚  â”‚ *.bean       â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                           â”‚                 â”‚                   â”‚
â”‚                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                                    â–¼                            â”‚
â”‚                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚                           â”‚ Fava         â”‚                      â”‚
â”‚                           â”‚ Container    â”‚                      â”‚
â”‚                           â”‚ (å¯è§†åŒ–)     â”‚                      â”‚
â”‚                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 Backend è®¾è®¡

> ä»“åº“ä½ç½®ï¼š`Beancount-Trans-Backend/project/apps/git_repository/`

#### 4.2.1 æ•°æ®æ¨¡å‹

```python
# project/apps/git_repository/models.py
from django.db import models
from django.contrib.auth import get_user_model
from project.models import BaseModel

User = get_user_model()

class GitRepository(BaseModel):
    """å¹³å°æ‰˜ç®¡çš„ç”¨æˆ· Git ä»“åº“
    
    è®¾è®¡è¯´æ˜ï¼š
    - æ¯ä¸ªç”¨æˆ·åªèƒ½æœ‰ä¸€ä¸ª Git ä»“åº“ï¼ˆOneToOneFieldï¼‰
    - ä»“åº“ç”±å¹³å°åœ¨ Gitea ä¸Šåˆ›å»ºå’Œç®¡ç†
    - ç”¨æˆ·é€šè¿‡ Deploy Key è¿›è¡Œ Git æ“ä½œ
    """
    
    # åŸºæœ¬ä¿¡æ¯
    owner = models.OneToOneField(
        User, 
        on_delete=models.CASCADE, 
        related_name='git_repo',
        help_text="ä»“åº“æ‰€æœ‰è€…"
    )
    repo_url = models.URLField(
        help_text="Gitea ä»“åº“ HTTPS URLï¼Œå¦‚ https://gitea.dhr2333.cn/beancount-trans/{user_id}-beancount.git"
    )
    repo_name = models.CharField(
        max_length=200, 
        help_text="ä»“åº“åç§°ï¼Œå¦‚ {user_id}-beancount"
    )
    gitea_repo_id = models.IntegerField(
        help_text="Gitea ä»“åº“ IDï¼Œç”¨äº API è°ƒç”¨"
    )
    
    # åˆ›å»ºæ–¹å¼
    created_with_template = models.BooleanField(
        default=True,
        help_text="æ˜¯å¦åŸºäºæ¨¡æ¿åˆ›å»ºï¼šTrue=åŸºäºæ¨¡æ¿ï¼ŒFalse=ç©ºä»“åº“"
    )
    
    # Deploy Key ä¿¡æ¯
    deploy_key_id = models.IntegerField(
        null=True, blank=True,
        help_text="Gitea Deploy Key ID"
    )
    deploy_key_private = models.TextField(
        help_text="Deploy Key ç§é’¥ï¼ˆåŠ å¯†å­˜å‚¨ï¼‰"
    )
    deploy_key_public = models.TextField(
        help_text="Deploy Key å…¬é’¥"
    )
    
    # åŒæ­¥çŠ¶æ€
    last_sync_at = models.DateTimeField(
        null=True, blank=True, 
        help_text="æœ€åä¸€æ¬¡ä»ä»“åº“æ‹‰å–æ—¶é—´"
    )
    sync_status = models.CharField(
        max_length=20, 
        default='pending', 
        choices=[
            ('pending', 'å¾…åŒæ­¥'), 
            ('syncing', 'åŒæ­¥ä¸­'), 
            ('success', 'æˆåŠŸ'), 
            ('failed', 'å¤±è´¥')
        ],
        help_text="åŒæ­¥çŠ¶æ€"
    )
    sync_error = models.TextField(
        blank=True, 
        help_text="æœ€åä¸€æ¬¡åŒæ­¥é”™è¯¯ä¿¡æ¯"
    )
    
    class Meta:
        db_table = 'git_repository'
        verbose_name = 'Git ä»“åº“'
        verbose_name_plural = 'Git ä»“åº“'
    
    def __str__(self):
        return f"{self.owner.username} - {self.repo_name}"
    
    @property
    def ssh_clone_url(self):
        """è·å– SSH clone åœ°å€"""
        return f"git@gitea.dhr2333.cn:beancount-trans/{self.repo_name}.git"
    
    @property
    def https_clone_url(self):
        """è·å– HTTPS clone åœ°å€"""
        return self.repo_url
```

#### 4.2.2 API è®¾è®¡

| æ¥å£ | æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|------|
| è·å–ä»“åº“ä¿¡æ¯ | GET | `/api/git/repository/` | è¿”å›ç”¨æˆ·çš„ Git ä»“åº“ä¿¡æ¯ï¼ˆæœªå¯ç”¨è¿”å› 404ï¼‰ |
| å¯ç”¨ Git åŠŸèƒ½ | POST | `/api/git/repository/` | åˆ›å»ºä»“åº“ï¼Œæ”¯æŒä¸¤ç§åˆ›å»ºæ–¹å¼ |
| ç®¡ç† Deploy Key | GET/POST | `/api/git/repository/deploy-key/` | GET: ä¸‹è½½ Deploy Key ç§é’¥æ–‡ä»¶ï¼›POST: é‡æ–°ç”Ÿæˆå¹¶ä¸‹è½½ Deploy Key |
| æ‰‹åŠ¨åŒæ­¥ | POST | `/api/git/sync/` | ä»è¿œç¨‹ä»“åº“æ‹‰å–æœ€æ–°å†…å®¹ |
| åŒæ­¥çŠ¶æ€ | GET | `/api/git/sync/status/` | è·å–åŒæ­¥çŠ¶æ€å’Œé”™è¯¯ä¿¡æ¯ |
| Webhook ç«¯ç‚¹ | POST | `/api/git/webhook/` | Gitea push äº‹ä»¶é€šçŸ¥ç«¯ç‚¹ï¼ˆæ— éœ€è®¤è¯ï¼‰ |
| ä¸‹è½½è§£æç»“æœ | GET | `/api/git/trans/download/` | ä¸‹è½½ trans/ ç›®å½•çš„ ZIP å‹ç¼©åŒ… |

**åˆ›å»ºä»“åº“ API è¯¦ç»†è¯´æ˜**ï¼š

```text
POST /api/git/repository/
Content-Type: application/json
Authorization: Bearer <token>

è¯·æ±‚ä½“ï¼š
{
  "template": true  // true=åŸºäºæ¨¡æ¿åˆ›å»º, false=ç©ºä»“åº“åˆ›å»º
}

æˆåŠŸå“åº” (201 Created)ï¼š
{
  "id": 1,
  "repo_url": "https://gitea.dhr2333.cn/beancount-trans/123-beancount.git",
  "ssh_clone_url": "git@gitea.dhr2333.cn:beancount-trans/123-beancount.git",
  "repo_name": "123-beancount",
  "created_with_template": true,
  "sync_status": "pending",
  "deploy_key_download_url": "/api/git/repository/deploy-key/"
}

é”™è¯¯å“åº” (400 Bad Request)ï¼š
{
  "error": "ç”¨æˆ·å·²æœ‰ Git ä»“åº“"
}
```

**API è°ƒç”¨åœºæ™¯åŒºåˆ†**ï¼š

| ç”¨æˆ·é€‰æ‹© | å‚æ•° | åˆ›å»ºç»“æœ | é€‚ç”¨åœºæ™¯ |
|----------|------|----------|----------|
| **åŸºäºæ¨¡æ¿åˆ›å»º** | `{"template": true}` | åŒ…å«æ ‡å‡†ç›®å½•ç»“æ„å’Œç¤ºä¾‹çš„ä»“åº“ | æ–°æ‰‹ç”¨æˆ·ï¼Œæƒ³è¦æ ‡å‡†è´¦æœ¬ç»“æ„ |
| **ç©ºä»“åº“åˆ›å»º** | `{"template": false}` | ç©ºä»“åº“ï¼Œç­‰å¾…ç”¨æˆ·æ¨é€ | å·²æœ‰è´¦æœ¬éœ€è¦è¿ç§»çš„ç”¨æˆ· |

#### 4.2.3 æ ¸å¿ƒæœåŠ¡è®¾è®¡

```python
# project/apps/git_repository/services.py

class PlatformGitService:
    """å¹³å°æ‰˜ç®¡ Gitea ä»“åº“æœåŠ¡
    
    èŒè´£ï¼š
    - ä»“åº“ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ˆåˆ›å»ºã€åˆ é™¤ï¼‰
    - Deploy Key ç®¡ç†ï¼ˆç”Ÿæˆã€é‡æ–°ç”Ÿæˆï¼‰
    - ä»“åº“åŒæ­¥ï¼ˆpullï¼‰
    - trans/ ç›®å½•ç®¡ç†
    """
    
    def create_user_repository(self, user, use_template=True):
        """ä¸ºç”¨æˆ·åˆ›å»º Git ä»“åº“
        
        Args:
            user: ç”¨æˆ·å¯¹è±¡
            use_template: æ˜¯å¦åŸºäºæ¨¡æ¿åˆå§‹åŒ–
                - True: åŸºäº Beancount-Trans-Assets æ¨¡æ¿åˆ›å»º
                - False: åˆ›å»ºç©ºä»“åº“ï¼Œç­‰å¾…ç”¨æˆ·æ¨é€
        
        æµç¨‹ï¼š
        1. è°ƒç”¨ Gitea API åˆ›å»ºä»“åº“
        2. ç”Ÿæˆ SSH å¯†é’¥å¯¹
        3. æ·»åŠ  Deploy Key åˆ°ä»“åº“
        4. é…ç½® Webhook
        5. å¦‚æœ use_template=Trueï¼Œåˆå§‹åŒ–ä»“åº“å†…å®¹
        6. ä¿å­˜ä»“åº“ä¿¡æ¯åˆ°æ•°æ®åº“
        
        Returns:
            GitRepository å®ä¾‹
        """
        pass
    
    def sync_repository(self, user):
        """ä»è¿œç¨‹ä»“åº“åŒæ­¥åˆ°æœ¬åœ°
        
        æ ¸å¿ƒå¤„ç†é€»è¾‘ï¼š
        1. å¤‡ä»½ trans/ ç›®å½•ä¸‹æ‰€æœ‰è§£ææ–‡ä»¶
        2. æ‰§è¡Œ git fetch + git reset --hard origin/mainï¼ˆä»¥è¿œç¨‹ä¸ºå‡†ï¼‰
        3. æ¢å¤å¤‡ä»½çš„è§£ææ–‡ä»¶åˆ° trans/ ç›®å½•
        4. é‡å»º trans/main.bean çš„ include å…³ç³»
        
        å†²çªå¤„ç†ï¼šå§‹ç»ˆä»¥è¿œç¨‹ä»“åº“ä¸ºå‡†ï¼Œå¹³å°æœ¬åœ°ä¿®æ”¹ä¼šè¢«è¦†ç›–
        """
        pass
    
    def regenerate_deploy_key(self, user):
        """é‡æ–°ç”Ÿæˆ Deploy Key
        
        æµç¨‹ï¼š
        1. ç”Ÿæˆæ–°çš„ SSH å¯†é’¥å¯¹
        2. åˆ é™¤ Gitea ä¸Šçš„æ—§ Deploy Key
        3. æ·»åŠ æ–°çš„ Deploy Key
        4. æ›´æ–°æ•°æ®åº“è®°å½•
        """
        pass
    
    def create_trans_download_archive(self, user):
        """åˆ›å»º trans/ ç›®å½•çš„ ZIP å‹ç¼©åŒ…ä¾›ç”¨æˆ·ä¸‹è½½"""
        pass
```

#### 4.2.4 Gitea API å®¢æˆ·ç«¯

```python
# project/apps/git_repository/clients.py

class GiteaAPIClient:
    """Gitea API å®¢æˆ·ç«¯
    
    å°è£…æ‰€æœ‰ Gitea API è°ƒç”¨ï¼Œä½¿ç”¨å¹³å°ç®¡ç†å‘˜ Token è¿›è¡Œè®¤è¯
    """
    
    def __init__(self):
        self.base_url = settings.GITEA_BASE_URL  # https://gitea.dhr2333.cn
        self.token = settings.GITEA_ADMIN_TOKEN
        self.org_name = "beancount-trans"
    
    def create_repository(self, repo_name, description, private=True):
        """åœ¨ beancount-trans ç»„ç»‡ä¸‹åˆ›å»ºä»“åº“"""
        pass
    
    def delete_repository(self, repo_name):
        """åˆ é™¤ä»“åº“"""
        pass
    
    def add_deploy_key(self, repo_name, title, public_key, read_only=False):
        """æ·»åŠ  Deploy Key"""
        pass
    
    def delete_deploy_key(self, repo_name, key_id):
        """åˆ é™¤ Deploy Key"""
        pass
    
    def create_webhook(self, repo_name, webhook_url, secret):
        """åˆ›å»º Webhook"""
        pass
    
    def get_repository_size(self, repo_name):
        """è·å–ä»“åº“å¤§å°"""
        pass
```

#### 4.2.5 ç¯å¢ƒå˜é‡é…ç½®

```python
# project/settings/settings.py æ–°å¢é…ç½®

# Gitea é…ç½®
GITEA_BASE_URL = os.environ.get('GITEA_BASE_URL', 'https://gitea.dhr2333.cn')
GITEA_ADMIN_TOKEN = os.environ.get('GITEA_ADMIN_TOKEN', '')  # å¿…å¡«
GITEA_ORG_NAME = os.environ.get('GITEA_ORG_NAME', 'beancount-trans')
GITEA_WEBHOOK_SECRET = os.environ.get('GITEA_WEBHOOK_SECRET', '')  # å¿…å¡«

# Git ä»“åº“é…ç½®
GIT_REPO_SIZE_LIMIT = int(os.environ.get('GIT_REPO_SIZE_LIMIT', 20 * 1024 * 1024))  # 20MB
```

### 4.3 Frontend è®¾è®¡

> ä»“åº“ï¼š`Beancount-Trans-Frontend/src/`

#### 4.3.1 æ–°å¢æ–‡ä»¶

| æ–‡ä»¶è·¯å¾„ | è¯´æ˜ |
|----------|------|
| `src/api/git.ts` | Git ç›¸å…³ API è°ƒç”¨ |
| `src/types/git.ts` | Git ç›¸å…³ TypeScript ç±»å‹å®šä¹‰ |
| `src/components/git/GitSetup.vue` | Git åŠŸèƒ½å¯ç”¨ç»„ä»¶ï¼ˆæœªå¯ç”¨æ—¶æ˜¾ç¤ºï¼‰ |
| `src/components/git/GitRepository.vue` | Git ä»“åº“ç®¡ç†ç»„ä»¶ï¼ˆå·²å¯ç”¨æ—¶æ˜¾ç¤ºï¼‰ |

#### 4.3.2 ç±»å‹å®šä¹‰

```typescript
// src/types/git.ts

export interface GitRepository {
  id: number
  repo_url: string
  ssh_clone_url: string
  repo_name: string
  created_with_template: boolean
  last_sync_at: string | null
  sync_status: 'pending' | 'syncing' | 'success' | 'failed'
  sync_error: string
  deploy_key_download_url: string
}

export interface CreateRepositoryRequest {
  template: boolean
}

export interface SyncStatus {
  status: 'pending' | 'syncing' | 'success' | 'failed'
  last_sync_at: string | null
  error: string
}
```

#### 4.3.3 ç•Œé¢è®¾è®¡

**GitSetup.vue - å¯ç”¨ Git åŠŸèƒ½**ï¼š

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”„ å¯ç”¨ Git åŒæ­¥åŠŸèƒ½                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Git åŒæ­¥å¯ä»¥è®©æ‚¨ï¼š                   â”‚
â”‚ â€¢ åœ¨æœ¬åœ°ä½¿ç”¨ Git ç®¡ç†è´¦æœ¬            â”‚
â”‚ â€¢ ç‰ˆæœ¬æ§åˆ¶å’Œå†å²è¿½è¸ª                 â”‚
â”‚ â€¢ å¤šè®¾å¤‡åŒæ­¥è´¦æœ¬æ•°æ®                 â”‚
â”‚                                     â”‚
â”‚ ğŸš€ [å¯ç”¨ Git åŒæ­¥]                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç‚¹å‡»åæ˜¾ç¤ºé€‰æ‹©ç•Œé¢ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“‹ é€‰æ‹©ä»“åº“åˆ›å»ºæ–¹å¼                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ğŸ¯ åŸºäºæ¨¡æ¿åˆ›å»ºï¼ˆæ¨èæ–°æ‰‹æˆ–éµå¾ªæœ€ä½³å®è·µï¼‰     â”‚ â”‚
â”‚ â”‚ â€¢ åŒ…å«æ ‡å‡†ç›®å½•ç»“æ„å’Œç¤ºä¾‹        â”‚ â”‚
â”‚ â”‚ â€¢ å¼€ç®±å³ç”¨ï¼Œæ— éœ€é…ç½®            â”‚ â”‚
â”‚ â”‚           [é€‰æ‹©æ­¤æ–¹å¼]          â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ğŸ“ ç©ºä»“åº“åˆ›å»ºï¼ˆæ¨èè¿ç§»ç”¨æˆ·ï¼‰   â”‚ â”‚
â”‚ â”‚ â€¢ ç©ºä»“åº“ï¼Œç­‰å¾…æ¨é€ç°æœ‰è´¦æœ¬      â”‚ â”‚
â”‚ â”‚ â€¢ ä¿ç•™ç°æœ‰è´¦æœ¬ç»“æ„              â”‚ â”‚
â”‚ â”‚           [é€‰æ‹©æ­¤æ–¹å¼]          â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ [å–æ¶ˆ]                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**GitRepository.vue - ä»“åº“ç®¡ç†**ï¼š

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âœ… Git ä»“åº“ç®¡ç†                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ä»“åº“åœ°å€: https://gitea.../123-beancount.git â”‚
â”‚ SSH åœ°å€: git@gitea...:beancount-trans/123-beancount.git â”‚
â”‚ åˆ›å»ºæ–¹å¼: åŸºäºæ¨¡æ¿ / ç©ºä»“åº“          â”‚
â”‚ æœ€ååŒæ­¥: 2025-12-02 16:30:00       â”‚
â”‚ åŒæ­¥çŠ¶æ€: âœ… æˆåŠŸ / â³ åŒæ­¥ä¸­ / âŒ å¤±è´¥ â”‚
â”‚                                     â”‚
â”‚ [ç«‹å³åŒæ­¥] [ä¸‹è½½è§£æç»“æœ]            â”‚
â”‚ [ä¸‹è½½ Deploy Key] [é‡æ–°ç”Ÿæˆ Deploy Key]â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 4.3.4 ç»„ä»¶é€»è¾‘

```typescript
// src/components/git/GitSettings.vueï¼ˆçˆ¶ç»„ä»¶ï¼‰

<script setup lang="ts">
import { ref, onMounted } from 'vue'
import { getGitRepository } from '@/api/git'
import GitSetup from './GitSetup.vue'
import GitRepository from './GitRepository.vue'

const repository = ref<GitRepository | null>(null)
const loading = ref(true)

onMounted(async () => {
  try {
    repository.value = await getGitRepository()
  } catch (e) {
    // 404 è¡¨ç¤ºæœªå¯ç”¨ Git
    repository.value = null
  } finally {
    loading.value = false
  }
})

const onRepositoryCreated = (repo: GitRepository) => {
  repository.value = repo
}
</script>

<template>
  <div v-loading="loading">
    <GitRepository v-if="repository" :repository="repository" />
    <GitSetup v-else @created="onRepositoryCreated" />
  </div>
</template>
```

### 4.4 Docs è®¾è®¡

> ä»“åº“ï¼š`Beancount-Trans-Docs/docs/`

#### 4.4.1 æ–°å¢æ–‡æ¡£

| æ–‡ä»¶è·¯å¾„ | è¯´æ˜ |
|----------|------|
| `docs/guide/git-sync.md` | Git åŒæ­¥åŠŸèƒ½ä½¿ç”¨æŒ‡å—ï¼ˆå¯ç”¨ã€é…ç½®ã€æ—¥å¸¸ä½¿ç”¨ï¼‰ |
| `docs/guide/migration.md` | è´¦æœ¬è¿ç§»æŒ‡å—ï¼ˆé’ˆå¯¹å·²æœ‰è´¦æœ¬çš„ç”¨æˆ·ï¼‰ |

#### 4.4.2 æ–‡æ¡£å†…å®¹è¦ç‚¹

**git-sync.md**ï¼š
- Git åŠŸèƒ½ä»‹ç»å’Œä¼˜åŠ¿
- ä¸¤ç§åˆ›å»ºæ–¹å¼çš„é€‰æ‹©æŒ‡å¯¼
- Deploy Key é…ç½®æ­¥éª¤
- æ—¥å¸¸åŒæ­¥å·¥ä½œæµ

**migration.md**ï¼š
- è¿ç§»å‰å‡†å¤‡ï¼ˆ.gitignore é…ç½®ã€main.bean é…ç½®ï¼‰
- æ¨é€ç°æœ‰è´¦æœ¬åˆ°å¹³å°
- éªŒè¯è¿ç§»ç»“æœ
- è·å–å¹³å°è§£æç»“æœ

### 4.5 æ•°æ®æµ

#### 4.5.1 è¿ç§»æœ¬åœ°è´¦æœ¬åˆ°å¹³å°

```text
ç”¨æˆ·æœ¬åœ°è´¦æœ¬ï¼ˆåŒ…å« .gitignore å¿½ç•¥ trans/ï¼‰
      â”‚
      â–¼ git push
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å¹³å°ä»£ç ä»“åº“      â”‚  â† ç”¨æˆ·æ¨é€è´¦æœ¬åˆ°å¹³å°ç§æœ‰ Gitea ä»“åº“
â”‚ (ç³»ç»Ÿè‡ªåŠ¨ä¸ºç”¨æˆ·åˆ›å»º)â”‚     æ³¨æ„ï¼štrans/ ç›®å½•åœ¨ .gitignore ä¸­
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚ ç”¨æˆ·åœ¨å¹³å°æ‰‹åŠ¨è§¦å‘åŒæ­¥æˆ–Webhookè§¦å‘åŒæ­¥
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å¹³å°åç«¯      â”‚  â† git clone åˆ° Assets/{username}/
â”‚ GitSyncService  â”‚     trans/ ç›®å½•ä¿ç•™ï¼ˆä¸è¢«è¦†ç›–ï¼‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Fava å¯è§†åŒ–   â”‚  â† æ˜¾ç¤ºç”¨æˆ·å†…å®¹ + trans/ è§£æç»“æœ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 4.5.2 å¹³å°è§£æè´¦å•ï¼ˆå†™å…¥ trans/ ç›®å½•ï¼‰

```text
ç”¨æˆ·ä¸Šä¼ è´¦å• â†’ å¹³å°è§£æ â†’ å†™å…¥ trans/*.bean
                              â”‚
                              â”‚ trans/ åœ¨ .gitignore ä¸­
                              â”‚ ä¸ä¼šè¢« git pull è¦†ç›–
                              â–¼
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚   Fava æ˜¾ç¤º     â”‚  â† ç”¨æˆ·å†…å®¹ + è§£æç»“æœ
                     â”‚   å®Œæ•´è´¦æœ¬      â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 4.5.3 ç”¨æˆ·è·å–è§£æç»“æœ

```text
ç”¨æˆ·åœ¨å¹³å°ç‚¹å‡»"ä¸‹è½½è§£æç»“æœ"
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å¹³å°ä¸‹è½½API    â”‚  â† è¿”å› trans/ ç›®å½•å‹ç¼©åŒ…
â”‚ /api/git/trans/ â”‚    
â”‚   download/     â”‚    
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”¨æˆ·æœ¬åœ°      â”‚  â† ç”¨æˆ·è§£å‹åˆ°æœ¬åœ° trans/ ç›®å½•ï¼ˆå¯é€‰ï¼‰
â”‚   trans/        â”‚     æœ¬åœ° trans/ ä¹Ÿåœ¨ .gitignore ä¸­
â”‚ï¼ˆå¯é€‰ä½¿ç”¨ï¼‰     â”‚     ç”¨æˆ·å®Œå…¨æ§åˆ¶æ˜¯å¦ä½¿ç”¨è§£æç»“æœ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ³¨æ„ï¼štrans/ ç›®å½•å¿…é¡»ä¿æŒåœ¨ .gitignore ä¸­ï¼Œ
      ä¸å»ºè®®çº³å…¥Gitç®¡ç†ï¼ˆä¼šäº§ç”Ÿå†²çªï¼‰
```

#### 4.5.4 ç”¨æˆ·æœ¬åœ°ä¿®æ”¹åŒæ­¥åˆ°å¹³å°

```text
ç”¨æˆ·æœ¬åœ°ç¼–è¾‘ç›®å½•æ–‡ä»¶
         â”‚
         â–¼ git commit + push
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Gitea å¹³å°       â”‚  â† è¿œç¨‹ä»“åº“æ›´æ–°
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ ç”¨æˆ·åœ¨å¹³å°æ‰‹åŠ¨è§¦å‘åŒæ­¥æˆ–Webhookè§¦å‘åŒæ­¥
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å¹³å°åç«¯      â”‚  â† git pull æ›´æ–°ç”¨æˆ·å†…å®¹
â”‚ GitSyncService  â”‚     trans/ ç›®å½•ä¸å—å½±å“ï¼ˆåœ¨ .gitignore ä¸­ï¼‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Fava æ˜¾ç¤º     â”‚  â† ç”¨æˆ·æœ€æ–°å†…å®¹ + ä¿ç•™çš„è§£æç»“æœ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. éªŒæ”¶æ ‡å‡†

### 5.1 åŠŸèƒ½éªŒæ”¶

#### 5.1.1 Git åŠŸèƒ½å¯ç”¨

| éªŒæ”¶é¡¹ | éªŒæ”¶æ ‡å‡† |
|--------|----------|
| é»˜è®¤çŠ¶æ€ | æ‰€æœ‰ç”¨æˆ·é»˜è®¤æœªå¯ç”¨ Git åŠŸèƒ½ï¼Œä½¿ç”¨ä¼ ç»Ÿ Web æ¨¡å¼ |
| å¯ç”¨å…¥å£ | è®¾ç½®é¡µé¢æ˜¾ç¤º"å¯ç”¨ Git åŒæ­¥"æŒ‰é’® |
| åˆ›å»ºæ–¹å¼é€‰æ‹© | ç‚¹å‡»å¯ç”¨åæ˜¾ç¤ºä¸¤ç§åˆ›å»ºæ–¹å¼ï¼ˆåŸºäºæ¨¡æ¿/ç©ºä»“åº“ï¼‰çš„é€‰æ‹©ç•Œé¢ |
| æ–¹å¼è¯´æ˜ | æ¸…æ¥šè¯´æ˜æ¯ç§æ–¹å¼çš„é€‚ç”¨åœºæ™¯å’Œåç»­æ­¥éª¤ |

#### 5.1.2 ä»“åº“åˆ›å»º

| éªŒæ”¶é¡¹ | éªŒæ”¶æ ‡å‡† |
|--------|----------|
| åŸºäºæ¨¡æ¿åˆ›å»º | ä»“åº“åŒ…å« `Beancount-Trans-Assets` æ¨¡æ¿çš„å®Œæ•´ç›®å½•ç»“æ„ |
| ç©ºä»“åº“åˆ›å»º | åˆ›å»ºç©ºä»“åº“ï¼Œæ— ä»»ä½•æ–‡ä»¶ï¼Œç­‰å¾…ç”¨æˆ·æ¨é€ |
| Deploy Key | ä¸¤ç§æ–¹å¼éƒ½è‡ªåŠ¨ç”Ÿæˆ Deploy Key å¹¶æ·»åŠ åˆ°ä»“åº“ |
| Webhook | è‡ªåŠ¨é…ç½® Webhookï¼Œç”¨äº push åè§¦å‘å¹³å°åŒæ­¥ |
| æƒé™è®¾ç½® | ä»“åº“è®¾ç½®ä¸ºç§æœ‰ï¼Œç¦ç”¨ Issues/Wiki/PR |
| å¤§å°é™åˆ¶ | ä»“åº“å¤§å°é™åˆ¶ä¸º 20MB |

#### 5.1.3 ä»“åº“åŒæ­¥

| éªŒæ”¶é¡¹ | éªŒæ”¶æ ‡å‡† |
|--------|----------|
| æ‰‹åŠ¨åŒæ­¥ | ç”¨æˆ·ç‚¹å‡»"ç«‹å³åŒæ­¥"å¯è§¦å‘ä»è¿œç¨‹æ‹‰å– |
| Webhook åŒæ­¥ | ç”¨æˆ· push å Gitea è§¦å‘ Webhookï¼Œå¹³å°è‡ªåŠ¨åŒæ­¥ |
| åŒæ­¥ç­–ç•¥ | åŒæ­¥æ—¶ä»¥è¿œç¨‹ä»“åº“ä¸ºå‡†ï¼ˆ`git reset --hard origin/main`ï¼‰ |
| trans/ ä¿ç•™ | åŒæ­¥è¿‡ç¨‹ä¸­ `trans/` ç›®å½•å†…å®¹ä¿ç•™ä¸è¢«è¦†ç›– |
| çŠ¶æ€æ˜¾ç¤º | æ˜¾ç¤ºåŒæ­¥çŠ¶æ€ï¼ˆå¾…åŒæ­¥/åŒæ­¥ä¸­/æˆåŠŸ/å¤±è´¥ï¼‰å’Œæœ€ååŒæ­¥æ—¶é—´ |
| é”™è¯¯å¤„ç† | åŒæ­¥å¤±è´¥æ—¶æ˜¾ç¤ºå…·ä½“é”™è¯¯ä¿¡æ¯ |

#### 5.1.4 trans/ ç›®å½•ç®¡ç†

| éªŒæ”¶é¡¹ | éªŒæ”¶æ ‡å‡† |
|--------|----------|
| è§£æç»“æœå†™å…¥ | å¹³å°è§£æè´¦å•åå†™å…¥ `trans/` ç›®å½• |
| Git å¿½ç•¥ | `trans/` ç›®å½•ä¸è¢« Git ç®¡ç†ï¼ˆé€šè¿‡ .gitignoreï¼‰ |
| include é‡å»º | åŒæ­¥åè‡ªåŠ¨é‡å»º `trans/main.bean` çš„ include å…³ç³» |
| ä¸‹è½½åŠŸèƒ½ | ç”¨æˆ·å¯ä¸‹è½½ `trans/` ç›®å½•çš„ ZIP å‹ç¼©åŒ… |

#### 5.1.5 Deploy Key ç®¡ç†

| éªŒæ”¶é¡¹ | éªŒæ”¶æ ‡å‡† |
|--------|----------|
| ä¸‹è½½ | ç”¨æˆ·å¯ä¸‹è½½ Deploy Key ç§é’¥æ–‡ä»¶ |
| é‡æ–°ç”Ÿæˆ | ç”¨æˆ·å¯é‡æ–°ç”Ÿæˆ Deploy Key |
| æƒé™ | Deploy Key å…·æœ‰ä»“åº“è¯»å†™æƒé™ |

### 5.2 API éªŒæ”¶

| API | æ–¹æ³• | éªŒæ”¶æ ‡å‡† |
|-----|------|----------|
| `/api/git/repository/` | GET | è¿”å›ç”¨æˆ·ä»“åº“ä¿¡æ¯ï¼Œæœªå¯ç”¨è¿”å› 404 |
| `/api/git/repository/` | POST | åˆ›å»ºä»“åº“æˆåŠŸè¿”å› 201ï¼Œå·²å­˜åœ¨è¿”å› 400 |
| `/api/git/repository/deploy-key/` | GET | è¿”å› Deploy Key ç§é’¥æ–‡ä»¶ä¸‹è½½ |
| `/api/git/repository/deploy-key/` | POST | é‡æ–°ç”Ÿæˆ Deploy Key æˆåŠŸè¿”å› 200 |
| `/api/git/sync/` | POST | è§¦å‘åŒæ­¥æˆåŠŸè¿”å› 200 |
| `/api/git/sync/status/` | GET | è¿”å›åŒæ­¥çŠ¶æ€ä¿¡æ¯ |
| `/api/git/webhook/` | POST | æ¥æ”¶ Gitea Webhook å¹¶è§¦å‘åŒæ­¥ |
| `/api/git/trans/download/` | GET | è¿”å› trans/ ç›®å½• ZIP æ–‡ä»¶ä¸‹è½½ |

### 5.3 å‰ç«¯éªŒæ”¶

| é¡µé¢/ç»„ä»¶ | éªŒæ”¶æ ‡å‡† |
|-----------|----------|
| GitSetup.vue | æœªå¯ç”¨ Git æ—¶æ˜¾ç¤ºï¼Œæä¾›å¯ç”¨å…¥å£å’Œåˆ›å»ºæ–¹å¼é€‰æ‹© |
| GitRepository.vue | å·²å¯ç”¨ Git æ—¶æ˜¾ç¤ºï¼Œå±•ç¤ºä»“åº“ä¿¡æ¯å’Œæ“ä½œæŒ‰é’® |
| åŒæ­¥çŠ¶æ€ | å®æ—¶æ˜¾ç¤ºåŒæ­¥çŠ¶æ€ï¼ŒåŒæ­¥ä¸­æ˜¾ç¤º loading |
| é”™è¯¯æç¤º | API é”™è¯¯æ—¶æ˜¾ç¤ºå‹å¥½çš„é”™è¯¯æç¤º |


## 6. ä»»åŠ¡åˆ†è§£

### ä»»åŠ¡ç¼–å·è§„åˆ™

| å‰ç¼€ | æ¨¡å— |
|------|------|
| BE | Backend |
| FE | Frontend |
| DOC | Docs |

### æ€»ä½“å·¥ä½œé‡ä¼°ç®—ï¼š2-3 å¤©

---

### Phase 1: åç«¯æ ¸å¿ƒåŠŸèƒ½ï¼ˆé¢„è®¡ 1-1.5 å¤©ï¼‰

#### BE-1: åˆ›å»º Django App å’Œæ•°æ®æ¨¡å‹ï¼ˆ2hï¼‰

- [ ] åˆ›å»º `project/apps/git_repository/` Django App
- [ ] å®ç° `GitRepository` æ¨¡å‹
- [ ] ç¼–å†™æ•°æ®åº“è¿ç§»æ–‡ä»¶
- [ ] æ³¨å†Œåˆ° `INSTALLED_APPS`

**äº§å‡ºç‰©**ï¼š
- `project/apps/git_repository/models.py`
- `project/apps/git_repository/admin.py`
- æ•°æ®åº“è¿ç§»æ–‡ä»¶

#### BE-2: å®ç° Gitea API å®¢æˆ·ç«¯ï¼ˆ2hï¼‰

- [ ] å®ç° `GiteaAPIClient` ç±»
- [ ] ä»“åº“åˆ›å»º API
- [ ] Deploy Key ç®¡ç† API
- [ ] Webhook é…ç½® API
- [ ] æ·»åŠ ç¯å¢ƒå˜é‡é…ç½®

**äº§å‡ºç‰©**ï¼š
- `project/apps/git_repository/clients.py`
- `docs/ENV_CONFIG.md` æ›´æ–°

#### BE-3: å®ç°æ ¸å¿ƒæœåŠ¡ï¼ˆ3hï¼‰â­ï¸ **å…³é”®ä»»åŠ¡**

- [ ] å®ç° `PlatformGitService` ç±»
- [ ] ä»“åº“åˆ›å»ºé€»è¾‘ï¼ˆä¸¤ç§åˆ›å»ºæ–¹å¼ï¼‰
- [ ] SSH å¯†é’¥å¯¹ç”Ÿæˆ
- [ ] ä»“åº“åŒæ­¥é€»è¾‘ï¼ˆå¤‡ä»½ trans/ â†’ pull â†’ æ¢å¤ trans/ï¼‰
- [ ] trans/main.bean include é‡å»ºé€»è¾‘
- [ ] trans/ ç›®å½• ZIP æ‰“åŒ…

**äº§å‡ºç‰©**ï¼š
- `project/apps/git_repository/services.py`

#### BE-4: å®ç° REST APIï¼ˆ2hï¼‰

- [ ] å®ç°åºåˆ—åŒ–å™¨
- [ ] å®ç°è§†å›¾é›†ï¼ˆä»“åº“ç®¡ç†ã€åŒæ­¥ã€Webhookï¼‰
- [ ] é…ç½® URL è·¯ç”±
- [ ] Webhook ç­¾åéªŒè¯

**äº§å‡ºç‰©**ï¼š
- `project/apps/git_repository/serializers.py`
- `project/apps/git_repository/views.py`
- `project/apps/git_repository/urls.py`

#### BE-5: å•å…ƒæµ‹è¯•ï¼ˆ1hï¼‰

- [ ] æ¨¡å‹æµ‹è¯•
- [ ] æœåŠ¡å±‚æµ‹è¯•ï¼ˆmock Gitea APIï¼‰
- [ ] API æµ‹è¯•

**äº§å‡ºç‰©**ï¼š
- `project/apps/git_repository/tests/`

---

### Phase 2: å‰ç«¯ç•Œé¢ï¼ˆé¢„è®¡ 0.5 å¤©ï¼‰

#### FE-1: ç±»å‹å®šä¹‰å’Œ API å°è£…ï¼ˆ0.5hï¼‰

- [ ] å®šä¹‰ `src/types/git.ts`
- [ ] å®ç° `src/api/git.ts`

**äº§å‡ºç‰©**ï¼š
- `src/types/git.ts`
- `src/api/git.ts`

#### FE-2: Git å¯ç”¨ç»„ä»¶ï¼ˆ1hï¼‰

- [ ] å®ç° `GitSetup.vue`
- [ ] åŠŸèƒ½ä»‹ç»å±•ç¤º
- [ ] ä¸¤ç§åˆ›å»ºæ–¹å¼é€‰æ‹©ç•Œé¢
- [ ] åˆ›å»ºæˆåŠŸåçš„åç»­æ­¥éª¤æŒ‡å¯¼

**äº§å‡ºç‰©**ï¼š
- `src/components/settings/GitSetup.vue`

#### FE-3: Git ä»“åº“ç®¡ç†ç»„ä»¶ï¼ˆ1.5hï¼‰

- [ ] å®ç° `GitRepository.vue`
- [ ] ä»“åº“ä¿¡æ¯å±•ç¤º
- [ ] Deploy Key ä¸‹è½½/é‡æ–°ç”Ÿæˆ
- [ ] åŒæ­¥è§¦å‘å’ŒçŠ¶æ€å±•ç¤º
- [ ] è§£æç»“æœä¸‹è½½

**äº§å‡ºç‰©**ï¼š
- `src/components/settings/GitRepository.vue`

#### FE-4: é›†æˆåˆ°è®¾ç½®é¡µé¢ï¼ˆ0.5hï¼‰

- [ ] ä¿®æ”¹è®¾ç½®é¡µé¢ï¼Œæ·»åŠ  Git åŒæ­¥ Tab
- [ ] æ ¹æ®ç”¨æˆ·çŠ¶æ€æ˜¾ç¤ºä¸åŒç»„ä»¶

**äº§å‡ºç‰©**ï¼š
- `src/views/settings/index.vue` ä¿®æ”¹

---

### Phase 3: æ–‡æ¡£ç¼–å†™ï¼ˆé¢„è®¡ 0.5 å¤©ï¼‰

#### DOC-1: Git åŒæ­¥ä½¿ç”¨æŒ‡å—ï¼ˆ1hï¼‰

- [ ] åŠŸèƒ½ä»‹ç»
- [ ] å¯ç”¨æµç¨‹
- [ ] Deploy Key é…ç½®
- [ ] æ—¥å¸¸ä½¿ç”¨å·¥ä½œæµ

**äº§å‡ºç‰©**ï¼š
- `Beancount-Trans-Docs/docs/guide/git-sync.md`

#### DOC-2: è´¦æœ¬è¿ç§»æŒ‡å—ï¼ˆ1hï¼‰

- [ ] è¿ç§»å‰å‡†å¤‡
- [ ] .gitignore å’Œ main.bean é…ç½®
- [ ] æ¨é€åˆ°å¹³å°
- [ ] éªŒè¯å’Œåç»­ä½¿ç”¨

**äº§å‡ºç‰©**ï¼š
- `Beancount-Trans-Docs/docs/guide/migration.md`

#### DOC-3: å¸¸è§é—®é¢˜ï¼ˆ0.5hï¼‰

- [ ] Deploy Key é…ç½®é—®é¢˜
- [ ] åŒæ­¥å¤±è´¥æ’æŸ¥
- [ ] trans/ ç›®å½•è¯´æ˜

**äº§å‡ºç‰©**ï¼š
- `Beancount-Trans-Docs/docs/faq/git.md`

---

### ä»»åŠ¡ä¾èµ–å…³ç³»

```text
BE-1 â†’ BE-2 â†’ BE-3 â†’ BE-4 â†’ BE-5
                â†“
              FE-1 â†’ FE-2 â†’ FE-3 â†’ FE-4
                              â†“
                           DOC-1 â†’ DOC-2 â†’ DOC-3
```

### é‡Œç¨‹ç¢‘

| é‡Œç¨‹ç¢‘ | å®Œæˆæ ‡å‡† | é¢„è®¡æ—¶é—´ |
|--------|----------|----------|
| M1: åç«¯ API å¯ç”¨ | BE-1 ~ BE-4 å®Œæˆï¼ŒAPI å¯é€šè¿‡ Postman æµ‹è¯• | Day 1 |
| M2: å‰ç«¯é›†æˆå®Œæˆ | FE-1 ~ FE-4 å®Œæˆï¼Œå¯é€šè¿‡ Web ç•Œé¢æ“ä½œ | Day 2 |
| M3: æ–‡æ¡£å’Œæµ‹è¯•å®Œæˆ | DOC-1 ~ DOC-3ã€BE-5 å®Œæˆ | Day 2-3 |

---

## 7. é£é™©ä¸ä¾èµ–

### 7.1 æŠ€æœ¯é£é™©

| é£é™© | å½±å“ç¨‹åº¦ | ç¼“è§£æªæ–½ |
|------|----------|----------|
| Gitea æœåŠ¡ä¸å¯ç”¨ | é«˜ | æœåŠ¡ç›‘æ§å‘Šè­¦ï¼ŒAPI é”™è¯¯æ—¶è¿”å›å‹å¥½æç¤º |
| Deploy Key æ³„éœ² | ä¸­ | åŠ å¯†å­˜å‚¨ç§é’¥ï¼Œæä¾›é‡æ–°ç”ŸæˆåŠŸèƒ½ |
| ç”¨æˆ·æ»¥ç”¨ä»“åº“å­˜å‚¨ | ä¸­ | ä»“åº“å¤§å°é™åˆ¶ 20MB |
| Git åŒæ­¥å†²çª | ä½ | å¼ºåˆ¶é‡ç½®ç­–ç•¥ï¼Œä»¥è¿œç¨‹ä»“åº“ä¸ºå‡† |

### 7.2 åŒæ­¥ç­–ç•¥

**æ ¸å¿ƒåŸåˆ™**ï¼šç”¨æˆ·çš„ Git ä»“åº“æ˜¯å”¯ä¸€çœŸç›¸æ¥æºï¼Œå¹³å°å®Œå…¨æœä»

| åœºæ™¯ | å¹³å°å¤„ç†æ–¹å¼ |
|------|--------------|
| æ­£å¸¸åŒæ­¥ | `git fetch` + `git reset --hard origin/main` |
| ç”¨æˆ·å¼ºåˆ¶æ¨é€ | åŒä¸Šï¼Œä»¥è¿œç¨‹ä¸ºå‡† |
| åŒæ­¥å¼‚å¸¸ | å¤‡ä»½ trans/ â†’ åˆ é™¤ä»“åº“ â†’ é‡æ–° clone â†’ æ¢å¤ trans/ |

**trans/ ç›®å½•ä¿æŠ¤**ï¼š
- åŒæ­¥å‰å¤‡ä»½ trans/ ç›®å½•æ‰€æœ‰æ–‡ä»¶
- åŒæ­¥åæ¢å¤å¤‡ä»½æ–‡ä»¶
- é‡å»º trans/main.bean çš„ include å…³ç³»

### 7.3 å¤–éƒ¨ä¾èµ–

| ä¾èµ– | è¯´æ˜ | çŠ¶æ€ |
|------|------|------|
| Gitea æœåŠ¡ | `https://gitea.dhr2333.cn/` | å¹³å°è‡ªå»º |
| ç³»ç»Ÿ git å‘½ä»¤ | clone/pull æ“ä½œ | æœåŠ¡å™¨å·²å®‰è£… |
| requests åº“ | è°ƒç”¨ Gitea API | éœ€æ–°å¢ |
| cryptography åº“ | SSH å¯†é’¥ç”Ÿæˆ | éœ€æ–°å¢ |

### 7.4 ç¯å¢ƒå˜é‡

| å˜é‡å | è¯´æ˜ | å¿…å¡« |
|--------|------|------|
| `GITEA_BASE_URL` | Gitea æœåŠ¡åœ°å€ | æ˜¯ |
| `GITEA_ADMIN_TOKEN` | Gitea ç®¡ç†å‘˜ Token | æ˜¯ |
| `GITEA_ORG_NAME` | ç»„ç»‡åç§°ï¼Œé»˜è®¤ `beancount-trans` | å¦ |
| `GITEA_WEBHOOK_SECRET` | Webhook ç­¾åå¯†é’¥ | æ˜¯ |
| `GIT_REPO_SIZE_LIMIT` | ä»“åº“å¤§å°é™åˆ¶ï¼Œé»˜è®¤ 20MB | å¦ |

### 7.5 å…¼å®¹æ€§è€ƒè™‘

- **Git åŠŸèƒ½å¯é€‰**ï¼šé»˜è®¤æœªå¯ç”¨ï¼Œç”¨æˆ·ä¸»åŠ¨å¯ç”¨
- **å‘åå…¼å®¹**ï¼šæœªå¯ç”¨ Git çš„ç”¨æˆ·å®Œå…¨ä¸å—å½±å“
- **ç°æœ‰å·¥ä½œæµ**ï¼šè§£æç»“æœç»§ç»­å†™å…¥ trans/ ç›®å½•ï¼Œé€»è¾‘ä¸å˜

---

## 8. å‚è€ƒèµ„æ–™

### Gitea API æ–‡æ¡£

- [Gitea API æ–‡æ¡£](https://docs.gitea.com/development/api-usage)
- [Deploy Key API](https://docs.gitea.com/api/1.20/#tag/repository/operation/repoCreateKey)
- [Webhook API](https://docs.gitea.com/api/1.20/#tag/repository/operation/repoCreateHook)

### é¡¹ç›®å†…éƒ¨å‚è€ƒ

- [BeanFileManager å®ç°](../Beancount-Trans-Backend/project/utils/file.py)
- [Beancount-Trans-Assets æ¨¡æ¿](../Beancount-Trans-Assets/)

---

## 9. é™„å½•

### 9.1 ç”¨æˆ·ä½¿ç”¨æµç¨‹

#### æµç¨‹ Aï¼šåŸºäºæ¨¡æ¿åˆ›å»ºï¼ˆæ¨èæ–°æ‰‹ï¼‰

```bash
# 1. åœ¨å¹³å°å¯ç”¨ Git åŠŸèƒ½ï¼Œé€‰æ‹©"åŸºäºæ¨¡æ¿åˆ›å»º"
# 2. ä¸‹è½½ Deploy Key å¹¶é…ç½® SSH

# é…ç½® SSH
chmod 600 ~/Downloads/deploy_key.pem
cat >> ~/.ssh/config << EOF
Host gitea-beancount
    HostName gitea.dhr2333.cn
    User git
    IdentityFile ~/Downloads/deploy_key.pem
EOF

# 3. å…‹éš†ä»“åº“
git clone gitea-beancount:beancount-trans/{user_id}-beancount.git ~/my-beancount
cd ~/my-beancount

# 4. ç¼–è¾‘è´¦æœ¬å¹¶æ¨é€
vim account/assets.bean
git add . && git commit -m "æ›´æ–°è´¦æˆ·" && git push
```

#### æµç¨‹ Bï¼šç©ºä»“åº“åˆ›å»ºï¼ˆè¿ç§»ç°æœ‰è´¦æœ¬ï¼‰

```bash
# 1. åœ¨å¹³å°å¯ç”¨ Git åŠŸèƒ½ï¼Œé€‰æ‹©"ç©ºä»“åº“åˆ›å»º"
# 2. ä¸‹è½½ Deploy Key å¹¶é…ç½® SSHï¼ˆåŒä¸Šï¼‰

# 3. å‡†å¤‡ç°æœ‰è´¦æœ¬
cd ~/my-existing-beancount
echo "trans/" >> .gitignore
echo 'include "trans/main.bean"' >> main.bean  # å¦‚æœæ²¡æœ‰

# 4. æ¨é€åˆ°å¹³å°
git init
git add .
git commit -m "è¿ç§»è´¦æœ¬åˆ°å¹³å°"
git remote add origin gitea-beancount:beancount-trans/{user_id}-beancount.git
git push -u origin main

# 5. åœ¨å¹³å°ç‚¹å‡»"ç«‹å³åŒæ­¥"éªŒè¯
```

### 9.2 åŒæ­¥çŠ¶æ€è¯´æ˜

| çŠ¶æ€ | è¯´æ˜ |
|------|------|
| `pending` | å¾…åŒæ­¥ï¼ˆåˆšåˆ›å»ºï¼Œå°šæœªé¦–æ¬¡åŒæ­¥ï¼‰ |
| `syncing` | åŒæ­¥ä¸­ |
| `success` | åŒæ­¥æˆåŠŸ |
| `failed` | åŒæ­¥å¤±è´¥ï¼ˆæŸ¥çœ‹é”™è¯¯ä¿¡æ¯ï¼‰ |

### 9.3 å¸¸è§é—®é¢˜

**Q: å¼ºåˆ¶æ¨é€ä¼šæ€æ ·ï¼Ÿ**
A: å¹³å°å®Œå…¨æœä»æ‚¨çš„ Git ä»“åº“ï¼Œä½¿ç”¨ `git reset --hard origin/main` åŒæ­¥ã€‚

**Q: ä¼šäº§ç”Ÿå†²çªå—ï¼Ÿ**
A: ä¸ä¼šã€‚å¹³å°åªè¯»å– Git å†…å®¹ï¼Œè§£æç»“æœå†™å…¥ `trans/`ï¼ˆä¸åœ¨ Git ä¸­ï¼‰ã€‚

**Q: ä¸ºä»€ä¹ˆ trans/ ä¸åœ¨ Git ä¸­ï¼Ÿ**
A: é¿å…å†²çªã€‚è§£æç»“æœé¢‘ç¹å˜åŒ–ï¼Œé€šè¿‡ API ä¸‹è½½æ›´çµæ´»ã€‚

**Q: ä»“åº“å¤§å°é™åˆ¶ï¼Ÿ**
A: 20MBï¼Œé˜²æ­¢æ»¥ç”¨ã€‚

**Q: Deploy Key ä¸¢å¤±æ€ä¹ˆåŠï¼Ÿ**
A: åœ¨å¹³å°è®¾ç½®ä¸­"é‡æ–°ç”Ÿæˆ Deploy Key"ã€‚
